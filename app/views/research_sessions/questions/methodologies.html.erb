<%= c('Step') do %>
  <%= c('Title', text: 'Methodologies') %>

  <%= c('ErrorSummary', errors: @research_session.errors.to_hash) if @research_session.errors.any? %>

  <%= c('Form', action: wizard_path, patch: true) do %>
    <%= c('OfManyChoiceControl',
      id: 'research_session[methodologies][]',
      name:'methodologies',
      collection: "research_session[#{:methodologies}][]",
      choices: Methodologies::NAME_VALUES,
      choices_selected: @research_session.methodologies,
      legend: 'How will you be gathering information?',
      choiceType: 'multi',
      errored: @research_session.errors['methodologies'].present?,
      validation: @research_session.errors['methodologies'][0]
    ) %>

    <%= c('OptionalField',
      isActive: (@research_session.methodologies.include?("other") if @research_session.methodologies.present?),
      controlled_by: '[id="research_session[other]"]') do %>
      <%= c('SinglelineTextControl',
        id: 'research_session[other_methodology]',
        name: 'other_methodology',
        value: @research_session.other_methodology,
        label: t('research_session_attr_labels.other_methodology'),
        size: 24,
        errored: @research_session.errors['other_methodology'].present?,
        validation: @research_session.errors['other_methodology'][0]
      ) %>
    <% end %>

    <%= render partial: 'submit_step' %>
  <% end %>

  <%= c('LivePreview') do %>
    <%= c('HeadingOne', text: t("preview.able_to_consent.what_happens_in_this_research_session.heading")) %>

    <%= c('Paragraph') do %>
      <%= raw t("preview.able_to_consent.what_happens_in_this_research_session.paragraphs")[0] % [
        c(
          'Output',
          text: @research_session.researcher_name,
          field: 'researcher_name',
          url: edit_link_for(:researcher_name)
        ),
        c(
          'Output',
          text: @research_session.researcher_job_title,
          field: 'researcher_job_title',
          url: edit_link_for(:researcher_job_title)
        )
      ] %>
    <% end %>

    <%= c('UnorderedList') do %>
      <% t('preview.able_to_consent.what_happens_in_this_research_session.methodologies').each do |key, value| %>
        <%= c('ChoicePreview', controlled_by: "[id=\"research_session[#{key}]\"]", isActive: (@research_session.methodologies.include?("#{key}") if @research_session.methodologies.present?)) do %>
          <% if key != :other %>
            <%= value %>
          <% else %>
            <%= c(
              'FieldPreview',
              text: @research_session.other_methodology,
              listens_to: '[name="research_session[other_methodology]"]'
            ) %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end %>
